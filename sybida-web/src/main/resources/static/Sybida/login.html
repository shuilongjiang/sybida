<!DOCTYPE html>
<html>
<head>
    <meta name="save" content="history">
    <meta name="renderer" content="webkit">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>思必达管理系统</title>
    <link rel="stylesheet"
          href="manager/layui-v2.5.6/layui/css/layui.css">
    <style>
        .layui-row {
            margin: 45px 0;
        }

        .captcha {
            height: 36px;
        }

        #login-form {
            background-color: rgba(255, 255, 255, .8);
            filter: progid:DXImageTransform.Microsoft.gradient(startcolorstr=#C8FFFF, endcolorstr=#C8FFFF);
            position: relative;
            padding: 30px 30px 10px;
        }

        #login-form .login-bottom {
            border-top: 1px #eee solid;
            padding: 10px 0 5px;
            color: #444;
        }

        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, .5);
            padding: 10px 0;

        }

        @media screen and (max-height: 640px) {
            .footer {
                position: relative;
            }
        }

        .footer p {
            text-align: center;
            color: #444;
        }

        #captcha {
            display: none;
        }

        .blur {
            -webkit-filter: blur(5px);
            -moz-filter: blur(5px);
            -ms-filter: blur(5px);
            filter: blur(5px);
        }
    </style>
</head>
<body style="background-color: rgb(199,237,204)">
<div class="layui-container">
    <div class="layui-row">
        <div class="layui-col-md3 " style="float: left">&nbsp;</div>
        <div class="layui-col-md5   layui-form layui-form-pane" style="float: left">
            <form method="post" id="login-form">
                <div class="layui-form-item">
                    <h2>思必达管理系统</h2>
                </div>
                <div id="pc-login">
                    <div class="layui-form-item">
                        <label for="L_account" class="layui-form-label">账号</label>
                        <div class="layui-input-block">
                            <input type="text" id="L_account" name="account" required
                                   lay-verify="required" autocomplete="off" class="layui-input"
                                   placeholder="请输入登录手机号">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="L_pass" class="layui-form-label">密码</label>
                        <div class="layui-input-block">
                            <input type="password" id="L_pass" name="pwd" required
                                   lay-verify="required" autocomplete="off" class="layui-input"
                                   placeholder="请输入密码">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="L_vercode" class="layui-form-label">验证码</label>
                        <div class="layui-input-inline">
                            <input type="text" id="L_vercode" name="verifycode" required
                                   lay-verify="required" placeholder="请输入验证码" autocomplete="off"
                                   class="layui-input">
                        </div>
                        <div class="layui-form-mid" style="padding: 0 !important; margin-right:0">
                            <canvas id="canvas" width="100" height="43"></canvas>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-filter="login" lay-submit>立即登录</button>
                        <span style="padding-left: 20px;">
							<a href="javascript:;" id="find-pass-btn">忘记密码</a>
						</span>
                    </div>
                </div>
                <div class="login-bottom">
                    <span id="online-user">在线人数：0</span>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="footer">
    <p>&copy; <span id="year"></span> &nbsp;思必达网络公司</p>
    <p>更好体验，请使用<a href='https://www.baidu.com/s?wd=%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8'
                  target="_blank">谷歌浏览器</a></p>
</div>
<script src="manager/jquery/jquery-3.3.1.js"></script>
<script src="manager/layui-v2.5.6/layui/layui.js"></script>
<script type="text/javascript">
</script>
<script>
    //获取在线人数
    var getOnlineUser = function () {
        $.get("/login/loginpeople",function (data) {
            $('#online-user').text('在线人数：' + data.code);
        },"json");
    }
    // 间隔5000获取一次
    getOnlineUser();
    var interval = setInterval(getOnlineUser, 5000);
    <!--验证码开始-->
    var show_num = [];
    draw(show_num);
    //验证码值
    $("#canvas").on('click', function () {
        draw(show_num);
    })
    function draw(show_num) {
        var canvas_width = $('#canvas').width();
        var canvas_height = $('#canvas').height();
        var canvas = document.getElementById("canvas");//获取到canvas的对象，演员
        var context = canvas.getContext("2d");//获取到canvas画图的环境，演员表演的舞台
        canvas.width = canvas_width;
        canvas.height = canvas_height;
        var sCode = "A,B,C,E,F,G,H,J,K,L,M,N,P,Q,R,S,T,W,X,Y,Z,1,2,3,4,5,6,7,8,9,0";
        var aCode = sCode.split(",");
        var aLength = aCode.length;//获取到数组的长度
        for (var i = 0; i <= 3; i++) {
            var j = Math.floor(Math.random() * aLength);//获取到随机的索引值
            var deg = Math.random() * 30 * Math.PI / 180;//产生0~30之间的随机弧度
            var txt = aCode[j];//得到随机的一个内容
            show_num[i] = txt.toLowerCase();
            var x = 10 + i * 20;//文字在canvas上的x坐标
            var y = 20 + Math.random() * 8;//文字在canvas上的y坐标
            context.font = "bold 23px 微软雅黑";
            context.translate(x, y);
            context.rotate(deg);
            context.fillStyle = randomColor();
            context.fillText(txt, 0, 0);
            context.rotate(-deg);
            context.translate(-x, -y);
        }
        for (var i = 0; i <= 5; i++) { //验证码上显示线条
            context.strokeStyle = randomColor();
            context.beginPath();
            context.moveTo(Math.random() * canvas_width, Math.random() * canvas_height);
            context.lineTo(Math.random() * canvas_width, Math.random() * canvas_height);
            context.stroke();
        }
        for (var i = 0; i <= 30; i++) { //验证码上显示小点
            context.strokeStyle = randomColor();
            context.beginPath();
            var x = Math.random() * canvas_width;
            var y = Math.random() * canvas_height;
            context.moveTo(x, y);
            context.lineTo(x + 1, y + 1);
            context.stroke();
        }
    }
    function randomColor() {//得到随机的颜色值
        var r = Math.floor(Math.random() * 256);
        var g = Math.floor(Math.random() * 256);
        var b = Math.floor(Math.random() * 256);
        return "rgb(" + r + "," + g + "," + b + ")";
    }
    <!--验证码结束-->
    layui.use(['layer', 'form'], function () {
        var layer = layui.layer
            , form = layui.form;
        var $ = layui.$;
        var $body = $('body');
        var myDate = new Date();
        $('#year').text(myDate.getFullYear());
        var device = layui.device();
        if ('') {
            layer.alert("", 8);
        }
        if (device.ie) {
            $body.prepend('<button class="layui-btn layui-btn-warm layui-btn-fluid">为了更好的体验请使用谷歌浏览器</button>');
 					layer.alert("您的浏览器版本过低,可能会导致部分功能异常,建议使用chrome浏览器或升级到更高版本!", 8);
        }




        $('#pc-login-btn').click(function () {
            clearTimeout(timeoutId);
            $('#qrcode-login').hide();
            $('#pc-login').show();
            $(this).hide();
            $('#qrcode-login-btn').show();
            $('#login-form .login-type .login-type-tips').text($('#qrcode-login-btn').attr('alt') + '>>');
        });
        var changeVerCode = function () {
            $('.captcha').attr('src', '/yzm?d=' + new Date().getTime());
        };
        $body.on('click', '.captcha', changeVerCode);
        $('#L_vercode').one('focus', function () {
            $('#captcha').show();
            changeVerCode();
        });
        // 调整登录框位置
        var h = $(window).height();
        if (h > 550) {
            $('#login-form').animate({
                marginTop: (h - 550) / 2 + 'px',
            }, 800, 'swing');
        }
        //监听提交
        form.on('submit(login)', function (data) {
            var num = show_num.join("");
            var account = $("#L_account").val();
            var password = $("#L_pass").val();
            var verifycode = $("#L_vercode").val();
            if (verifycode.toLowerCase() == num) {
                $.post("/login/logincheck","phone="+account+"&psw="+password ,function (data) {
                    if(data.code==1){
                        layer.msg('登录成功  正在为您跳转...');
                        window.location.href = "manager/managerIndex.html";
                        // if(data.data.userAuthority==0){
                        //     layer.msg('登录成功  正在为您跳转...');
                        //     window.location.href = "manager/managerIndex.html";
                        // }else  if(data.data.userAuthority==1)
                        // {
                        //     layer.msg('登录成功  正在为您跳转...');
                        //     window.location.href = "manager/managerIndex.html";
                        // }else if(data.data.userAuthority==2){
                        //
                        // }
                    }else{
                            layer.alert("手机号或密码错误，请重新输入！", {icon: 2});
                            draw(show_num);
                    }

                },"json");

            } else {
                layer.alert("验证码错误，请重新输入！", {icon: 2});
                draw(show_num);
            }
            draw(show_num);
            return false;
        });
        $('#find-pass-btn').click(showFetch);
        function showFetch() {
            var width = '350px';
            width = '300px';
            layer.open({
                type: 1,//Page层类型
                area: ['500px', width],
                skin: "",
                title: ['找回密码',
                    'border:none; background:#CAE1FF; color:#000;'],
                shade: 0.6, //遮罩透明度
                maxmin: false, //允许全屏最小化
                anim: 3, //0-6的动画形式，-1不开启
                content: $('#findPassTpl').html(),
                success: function (layero, index) {
                    changeVerCode();
                    bindSendFn(); //绑定发送短信
                    $("#btnSendCode1").click(function () {
                        $("#btnSendCode1").attr("disabled", "disabled")
                        reloadSendBtn(60);
                    })
                }

            });
        }

        function bindSendFn() {
            // 发送短信
            $('#sendShortMessageBtn').on('click', function () {
                var account = $("#account").val();
                var phoneNumber = $("#phoneNumber").val();
                if (!account) {
                    layer.msg("请输入账号");
                    $("#account").focus();
                    return false;
                }
                if (!phoneNumber) {
                    layer.msg("请输入手机号码");
                    $("#phoneNumber").focus();
                    return false;
                }

                var l_index = layer.load(1, {
                    shade: [0.1, '#fff']
                    //0.1透明度的白色背景
                });
                $.ajax({
                    url: "/new/fetchmm/sendShortMessage",
                    type: "post",
                    data: {
                        account: account,
                        phoneNumber: phoneNumber
                    },
                    dataType: "json",
                    complete: function () {
                        layer.close(l_index);
                    },
                    success: function (result) {
                        if (result.code >= 0) {//成功
                            reloadSendBtn(60);
                            layer.alert(result.message, 7);
                        } else {//失败
                            changeVerCode();
                            layer.alert(result.message);
                        }
                    },
                    error: function () {
                        layer.alert("请求超时，请稍后重试！");
                    }
                });
            });
        }

        // 控制发送短信的按钮
        function reloadSendBtn(second) {
            if (second <= 0) {
                $('#btnSendCode1').removeClass("layui-btn-disabled").attr("disabled", false).val("获取验证码");
            } else {
                $('#btnSendCode1').addClass("layui-btn-disabled").attr("disabled", true).val("获取验证码(" + second + ")");
                setTimeout(function () {
                    reloadSendBtn(second - 1)
                }, 1000);
            }
        }


        form.on('submit(fetch)', function (data) {

            var l_index = layer.load(1, {
                shade: [0.1, '#fff']
                //0.1透明度的白色背景
            });

            var account = data.field.account;
            var mmtip = data.field.mmtip;
            var verifycode = data.field.verifycode;
            var messageVerifycode = data.field.messageVerifycode;
            var phoneNumber = data.field.phoneNumber;
            //
            // var key = CryptoJS.enc.Utf8.parse(verifycode + verifycode + verifycode + verifycode);
            // var srcs = CryptoJS.enc.Utf8.parse(mmtip);
            // var encrypted = CryptoJS.AES.encrypt(srcs, key, {mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7});
            // mmtip = encrypted.ciphertext.toString();

            $.ajax({
                url: "/new/fetchmm",
                type: "post",
                data: {
                    account: account,
                    mmtip: mmtip,
                    verifycode: verifycode,
                    phoneNumber: phoneNumber,
                    messageVerifycode: messageVerifycode
                },
                dataType: "json",
                complete: function () {
                    layer.close(l_index);
                },
                success: function (result) {
                    if (result.code >= 0) {//成功
                        layer.alert(result.message + "，<br>登陆后请尽快修改",
                            7, function () {
                                changeVerCode();
                                layer.closeAll();
                            });
                    } else {//失败
                        changeVerCode();
                        layer.alert(result.message);
                    }
                },
                error: function () {
                    layer.alert("登录超时，请稍后重试！");
                }
            });

            return false;
        });
    });


</script>

<script type="text/html" id="findPassTpl">
    <div style="padding:20px;">
        <form class="layui-form layui-form-pane" action="" lay-filter="fetchForm">
            <div class="layui-form-item">
                <label class="layui-form-label">手机号</label>
                <div class="layui-input-block">
                    <input type="text" name="account" id="account" autocomplete="off"
                           lay-verify="required" placeholder="请输入注册手机号" class="layui-input">
                </div>
            </div>
            <br>
            <div class="layui-form-item">
                <label class="layui-form-label">验证码</label>
                <div class="layui-input-inline">
                    <input type="text" name="verifycode"
                           lay-verify="required" placeholder="请输入验证码" autocomplete="off"
                           class="layui-input">
                </div>
                <input id="btnSendCode1" type="button" class="btn btn-default layui-btn layui-btn-warm" value="获取验证码"/>

                <div class="layui-form-mid" style="padding: 0 !important; margin-right:0">

                </div>
                <br><br>
            </div>
            <div class="layui-form-item">
                <button class="layui-btn layui-btn-warm" lay-filter="fetch" lay-submit>找回</button>&nbsp;&nbsp;&nbsp;&nbsp;
                <span style="color: red">找回后默认密码为1234</span>

            </div>

        </form>
    </div>

</script>
<script>

</script>

</body>
</html>